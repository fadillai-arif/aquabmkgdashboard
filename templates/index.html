<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>
  <!-- Bootstrap CDN untuk cepat -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">AQUA Site Early Warning System Dashboard</span>
      <div class="d-flex">
        <form action="{{ url_for('run_check') }}" method="post" class="me-2">
          <button type="submit" class="btn btn-light btn-sm">Run Weather Check</button>
        </form>
        <form action="{{ url_for('reset_alerts') }}" method="post" class="me-2">
          <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Reset all alerts?')">Reset Alerts</button>
        </form>
        <a href="{{ url_for('history_7d') }}" class="btn btn-info btn-sm">Log Record 7 Hari</a>
        {% if is_history %}
          <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm ms-2">Back to Dashboard</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <div class="container mb-5">
    <div class="row g-4">
      <!-- Peta Terakhir -->
      {% if not is_history %}
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <h5 class="mb-0">Peta Deteksi Awan Hujan (Terbaru)</h5>
            <small class="text-muted">Terakhir diperbarui: {{ current_time if current_time else '—' }}</small>
          </div>
          <div class="card-body text-center">
            {% if latest_map_rel %}
              <img class="img-fluid rounded border" src="{{ url_for('static', filename=latest_map_rel) }}" alt="Peta Potensi Hujan Lebat">
            {% else %}
              <div class="alert alert-secondary">Belum ada peta yang tersedia.</div>
            {% endif %}
            <div class="mt-3">
              <span class="legend-chip legend-waspada">WASPADA</span>
              <span class="legend-chip legend-siaga">SIAGA</span>
              <span class="legend-chip legend-bahaya">BAHAYA</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Lokasi & Status -->
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Lokasi Terdeteksi</h5>
            <small class="text-muted">{{ current_alerts|length }} lokasi</small>
          </div>
          <div class="card-body">
            {% if current_alerts %}
              <ul class="list-group">
                {% for item in current_alerts %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">{{ item.location }}</div>
                      <small class="text-muted">Count: {{ item.count }}x{% if item.dominant_color %} • Warna: {{ item.dominant_color }}{% endif %}</small>
                      {% if item.weather_warning %}
                        <div><small class="badge bg-secondary">{{ item.weather_warning }}</small></div>
                      {% endif %}
                    </div>
                    <span class="status-chip" style="background-color: {{ item.chip_color }}">{{ item.level }}</span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="alert alert-success mb-0">Tidak ada lokasi dengan peringatan saat ini.</div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Riwayat (ringkas) -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <h5 class="mb-0">{{ 'Riwayat Log Alarm (7 Hari)' if is_history else 'Log Alarm (Maks 5 Record)' }}</h5>
          </div>
          <div class="card-body">
            {% if recent_entries %}
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th style="width: 220px;">Waktu (WIB)</th>
                      <th>Lokasi & Level</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for entry in recent_entries|reverse %}
                      <tr>
                        <td><code>{{ entry.time_wib }}</code></td>
                        <td>
                          {% if entry.locations %}
                            {% for loc in entry.locations %}
                              {% set lvl = loc.level or ('BAHAYA' if (loc.count|int) >= 10 else ('SIAGA' if (loc.count|int) >= 5 else ('WASPADA' if (loc.count|int) >= 1 else ''))) %}
                              {% set color = '#e74c3c' if lvl == 'BAHAYA' else ('#e67e22' if lvl == 'SIAGA' else ('#f1c40f' if lvl == 'WASPADA' else '#95a5a6')) %}
                              <span class="status-chip me-1 mb-1" style="background-color: {{ color }}">{{ loc.location }} ({{ loc.count }}x {{ lvl }})</span>
                            {% endfor %}
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-secondary mb-0">Belum ada log.</div>
            {% endif %}
          </div>
        </div>
      </div>

    </div>
  </div>

  <footer class="text-center text-muted small mb-4">
    © {{ datetime.utcnow().year }} AQUA EWS
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
